<!DOCTYPE html>
<html lang="id" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stok Gudang Divisi PP</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-gray-800 p-4 text-center text-2xl font-bold shadow">
    ðŸ“¦ Stok Gudang Divisi PP
  </header>

  <main class="flex-1 p-6 grid grid-cols-1 md:grid-cols-2 gap-6">

    <!-- Form Tambah Produk -->
    <section class="bg-gray-800 p-4 rounded-xl shadow">
      <h2 class="text-xl font-semibold mb-4">Tambah Produk</h2>
      <form id="productForm" class="space-y-3">
        <input id="nama" type="text" placeholder="Nama Produk" class="w-full p-2 rounded text-black" required>
        <input id="kategori" type="text" placeholder="Kategori Produk" class="w-full p-2 rounded text-black" required>
        <input id="jumlah" type="number" placeholder="Jumlah" class="w-full p-2 rounded text-black" required>
        <input id="penginput" type="text" placeholder="Nama Penginput" class="w-full p-2 rounded text-black" required>
        <button type="submit" class="bg-green-600 px-4 py-2 rounded-lg hover:bg-green-700 w-full">Tambah Produk</button>
      </form>
    </section>

    <!-- Daftar Produk -->
    <section class="bg-gray-800 p-4 rounded-xl shadow flex flex-col">
      <h2 class="text-xl font-semibold mb-4">Daftar Produk</h2>
      <input type="text" id="searchProduk" placeholder="Cari produk..." class="w-full p-2 mb-3 rounded text-black">
      <div id="produkList" class="overflow-y-auto h-80 border border-gray-700 rounded p-2"></div>
    </section>

    <!-- Riwayat -->
    <section class="bg-gray-800 p-4 rounded-xl shadow flex flex-col md:col-span-2">
      <h2 class="text-xl font-semibold mb-4">Riwayat Perubahan</h2>
      <div class="flex gap-2 mb-3">
        <select id="filterRiwayat" class="p-2 rounded text-black">
          <option value="7">7 Hari Terakhir</option>
          <option value="30">30 Hari Terakhir</option>
          <option value="all">Semua</option>
        </select>
        <input type="date" id="tanggalSpesifik" class="p-2 rounded text-black">
      </div>
      <div id="riwayatList" class="overflow-y-auto h-80 border border-gray-700 rounded p-2"></div>
    </section>

  </main>

  <!-- Firebase & Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, setDoc, getDoc, doc, updateDoc, 
      increment, onSnapshot, query, orderBy, where 
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // âœ… Config Firebase punyamu
    const firebaseConfig = {
      apiKey: "AIzaSyCk_9zFTS5CRgmIcuswG_gvpLVWx2PcF58",
      authDomain: "stok-gudang-divisi-pp.firebaseapp.com",
      projectId: "stok-gudang-divisi-pp",
      storageBucket: "stok-gudang-divisi-pp.firebasestorage.app",
      messagingSenderId: "838303987838",
      appId: "1:838303987838:web:e16829f449925469ae002f",
      measurementId: "G-QYH5LD18NT"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const produkList = document.getElementById("produkList");
    const riwayatList = document.getElementById("riwayatList");

    // ðŸ”¹ Tambah Produk
    document.getElementById("productForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const nama = document.getElementById("nama").value.trim();
      const kategori = document.getElementById("kategori").value.trim();
      const jumlah = parseInt(document.getElementById("jumlah").value);
      const penginput = document.getElementById("penginput").value.trim();

      // âœ… Validasi
      if (!nama) return alert("Nama produk wajib diisi!");
      if (!kategori) return alert("Kategori wajib diisi!");
      if (!jumlah || jumlah <= 0) return alert("Jumlah harus lebih dari 0!");
      if (!penginput) return alert("Nama penginput wajib diisi!");

      const productRef = doc(db, "produk", nama);
      const docSnap = await getDoc(productRef);

      if (docSnap.exists()) {
        await updateDoc(productRef, { jumlah: increment(jumlah) });
      } else {
        await setDoc(productRef, { nama, kategori, jumlah });
      }

      await addDoc(collection(db, "riwayat"), {
        nama, kategori, jumlah, penginput, waktu: new Date()
      });

      e.target.reset();
    });

    // ðŸ”¹ Realtime Daftar Produk
    onSnapshot(collection(db, "produk"), (snapshot) => {
      produkList.innerHTML = "";
      snapshot.forEach((doc) => {
        const p = doc.data();
        produkList.innerHTML += `
          <div class="border-b border-gray-700 py-1">
            <span class="font-bold">${p.nama}</span> 
            <span class="text-gray-400">(${p.kategori})</span> 
            - <span class="text-green-400">${p.jumlah}</span>
          </div>`;
      });
    });

    // ðŸ”¹ Realtime Riwayat
    onSnapshot(query(collection(db, "riwayat"), orderBy("waktu", "desc")), (snapshot) => {
      riwayatList.innerHTML = "";
      snapshot.forEach((doc) => {
        const r = doc.data();
        const waktu = r.waktu.toDate().toLocaleString("id-ID");
        riwayatList.innerHTML += `
          <div class="border-b border-gray-700 py-1">
            <span class="font-bold">${r.nama}</span> 
            (${r.kategori}) sejumlah <span class="text-green-400">+${r.jumlah}</span> 
            oleh <span class="text-blue-400">${r.penginput}</span> 
            <span class="text-gray-400">(${waktu})</span>
          </div>`;
      });
    });

  </script>
</body>
</html>
